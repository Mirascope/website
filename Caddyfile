{
    # Use Caddy's internal CA for automatic certificate management
    local_certs
    
    # Disable OCSP stapling to avoid delays with local certs
    ocsp_stapling off
    
    # Enable verbose logging with request timing
    log {
        output stdout
        level DEBUG
        format console
    }
}

runnable.localhost:80 {
	redir https://runnable.localhost{uri} permanent
}

# Bind to IPv4 explicitly to avoid browser IPv6 connection timeout delays
runnable.localhost:443 {
	# Required headers for SharedArrayBuffer support (needed for interrupt buffer)
	# Note: These headers are required for SharedArrayBuffer
	# header Cross-Origin-Opener-Policy "same-origin"
	# header Cross-Origin-Embedder-Policy "require-corp"
	
	reverse_proxy http://127.0.0.1:3000 {
		# Reduce connection timeout to fail faster if upstream is down
		transport http {
			dial_timeout 2s
		}
	}

	handle_path /openai/* {
		reverse_proxy https://api.openai.com {
			header_up Host api.openai.com
			header_up Authorization "Bearer {env.OPENAI_API_KEY}"
			header_up Content-Type "application/json"
		}
	}

	handle_path /anthropic/* {
		reverse_proxy https://api.anthropic.com {
			header_up Host api.anthropic.com
			header_up x-api-key "{env.ANTHROPIC_API_KEY}"
			header_up anthropic-dangerous-direct-browser-access "true"
			header_up Content-Type "application/json"
			
			# Remove Accept-Encoding to prevent upstream from sending compressed responses
			# This avoids issues with Pyodide's httpx trying to decompress already-decompressed data
			header_up -Accept-Encoding
		}
	}
}
